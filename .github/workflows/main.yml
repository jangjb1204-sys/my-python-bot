name: US Stock Auto Analysis

# 실행 조건 설정
on:
  schedule:
    # 매일 한국 시간 오전 8시 (UTC 기준 전날 23시)에 자동 실행
    - cron: '0 */1 * * *'
  workflow_dispatch: # 깃허브 웹사이트에서 버튼을 눌러 즉시 실행 가능

# 저장소에 파일을 쓸 수 있는 권한 부여 (403 에러 해결책)
permissions:
  contents: write

jobs:
  run-analysis:
    runs-on: ubuntu-latest # 최신 리눅스 환경에서 실행

    steps:
      # 1. 저장소의 코드를 서버로 가져옴
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 파이썬 3.10 설치 (최신 라이브러리 호환성)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. 필요한 라이브러리 설치 (requirements.txt 기준)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. 파이썬 스크립트 실행 (US_stock 폴더에 결과물 생성)
      - name: Run main script
        run: python main.py

      # 5. 생성된 결과물(엑셀, 이미지)을 저장소에 다시 업로드
      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # US_stock 폴더에 생긴 모든 변화를 추가
          git add US_stock/*
          
          # 변경사항이 있을 때만 커밋 (없으면 에러 없이 통과)
          git commit -m "Auto-update: $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          
          # 저장소로 전송
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
